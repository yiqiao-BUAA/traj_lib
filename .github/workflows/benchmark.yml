# .github/workflows/benchmark.yml
name: Benchmark CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  benchmark:
    if: startsWith(github.event.pull_request.title, '[bench]')
    runs-on: [self-hosted]
    timeout-minutes: 120

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 解析 PR 标题参数
      - name: Extract benchmark args
        id: args
        shell: bash
        run: |
          title="${{ github.event.pull_request.title }}"
          model=""
          dataset="all"
          metrics="all"

          for kv in $title; do
            [[ $kv =~ model=(.*)   ]] && model="${BASH_REMATCH[1]}"
            [[ $kv =~ dataset=(.*) ]] && dataset="${BASH_REMATCH[1]}"
            [[ $kv =~ metrics=(.*) ]] && metrics="${BASH_REMATCH[1]}"
          done

          if [[ -z "$model" ]]; then
            echo >&2 "❌ PR 标题缺少 model=<name>"
            exit 1
          fi

          printf "model=%s\ndataset=%s\nmetrics=%s\n" \
                 "$model" "$dataset" "$metrics" >> "$GITHUB_OUTPUT"

      # 3. 运行基准脚本
      - name: Run benchmark
        env:
          PYTHONPATH: ${{ github.workspace }}/..
          MODEL:   ${{ steps.args.outputs.model }}
          DATASET: ${{ steps.args.outputs.dataset }}
          METRICS: ${{ steps.args.outputs.metrics }}
        run: |
          /home/qiaoyi/.conda/envs/sign_hmm/bin/python -m traj_lib.main \
            --model   "$MODEL" \
            --dataset "$DATASET" \
            --metrics "$METRICS"

      # 4. 上传本次结果为 artifact（可选）
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: bench-result
          path: ${{ github.workspace }}/outputs/**/*.json

      # 5. 生成并合并全量排行榜
      - name: Generate full leaderboard
        id: full_table
        shell: bash
        run: |
          set -e
          cd $GITHUB_WORKSPACE

          # 初始化 benchmarks.md
          if [ ! -f benchmarks.md ]; then
            echo "| Model | Dataset | Metric | Score | Date |" > benchmarks.md
            echo "|-------|---------|--------|-------|------|" >> benchmarks.md
          fi

          # 合并历史和本次结果，输出到临时文件
          python << 'PYTHON' > new_benchmarks.md
          import json, glob, datetime, re

          # 读取历史
          hist = []
          with open("benchmarks.md") as f:
              for line in f.read().splitlines()[2:]:
                  m = re.match(r"\|\s*(\S+)\s*\|\s*(\S+)\s*\|\s*(\S+)\s*\|\s*([\d\.]+)\s*\|\s*([\d\-]+)\s*\|", line)
                  if m:
                      hist.append({
                          "model": m.group(1),
                          "dataset": m.group(2),
                          "metric": m.group(3),
                          "score": float(m.group(4)),
                          "date": m.group(5),
                      })

          # 追加本次结果
          today = datetime.date.today().isoformat()
          for path in glob.glob("outputs/*.json"):
              obj = json.load(open(path))
              for metric, score in obj["scores"].items():
                  hist.append({
                      "model": obj["model"],
                      "dataset": obj["dataset"],
                      "metric": metric,
                      "score": score,
                      "date": today,
                  })

          # 去重，按 (model, dataset, metric) 保留最新
          keyed = {}
          for rec in hist:
              key = (rec["model"], rec["dataset"], rec["metric"])
              keyed[key] = rec

          # 写回表格
          lines = ["| Model | Dataset | Metric | Score | Date |",
                  "|-------|---------|--------|-------|------|"]
          for rec in sorted(keyed.values(), key=lambda x: (x["model"], x["dataset"], x["metric"])):
              lines.append(f"| {rec['model']} | {rec['dataset']} | {rec['metric']} | {rec['score']:.4f} | {rec['date']} |")

          print("\n".join(lines))
          PYTHON

          mv new_benchmarks.md benchmarks.md

      # 6. 提交并推送更新后的排行榜
      - name: Commit updated leaderboard
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: 更新 benchmark 全量排行榜"
          file_pattern: benchmarks.md
          branch: ${{ github.head_ref }}
